<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Activation Portal</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <style>
        /* Login Styles */
        .login-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        .hidden {
            display: none;
        }

        /* Data Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        /* Rest of your existing styles */
        /* ... (keep previous styles) ... */
    </style>
</head>
<body>
    <!-- Login Section -->
    <div id="loginSection" class="login-container">
        <h2>Staff Login</h2>
        <form id="loginForm">
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="username" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="password" required>
            </div>
            <button type="submit">Login</button>
            <div id="loginError" class="error-message"></div>
        </form>
    </div>

    <!-- User Dashboard -->
    <div id="userDashboard" class="hidden">
        <h2>Welcome, <span id="userGreeting"></span></h2>
        <button onclick="logout()">Logout</button>
        
        <!-- Data Entry Form -->
        <div id="entryForm">
            <!-- Your existing form here -->
        </div>

        <!-- User Data Table -->
        <h3>Your Submissions</h3>
        <table id="userData">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Market</th>
                    <th>Customer</th>
                    <th>Sale Amount</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="hidden">
        <h2>Admin Dashboard</h2>
        <button onclick="logout()">Logout</button>
        
        <div>
            <h3>All Users Data</h3>
            <select id="userSelect" onchange="loadUserData()">
                <option value="">Select User</option>
            </select>
            <table id="adminData">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Date</th>
                        <th>Market</th>
                        <th>Customer</th>
                        <th>Sale Amount</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAG2FCJ5yq-fpzkIGPJNXhUmV4C0yBCLvw",
            authDomain: "bpdb-7917b.firebaseapp.com",
            projectId: "bpdb-7917b",
            storageBucket: "bpdb-7917b.firebasestorage.app",
            messagingSenderId: "257010241868",
            appId: "1:257010241868:web:051531214d73c21558bfe9",
            measurementId: "G-TMETXCTQGL"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // User Roles Setup
        const users = {
            'user001': {email: 'user001@example.com', password: 'user001', role: 'user'},
            'user002': {email: 'user002@example.com', password: 'user002', role: 'user'},
            'admin': {email: 'admin@example.com', password: 'admin123', role: 'admin'}
        };

        // Login Handler
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!users[username] || users[username].password !== password) {
                alert('Invalid credentials');
                return;
            }

            try {
                await auth.signInWithEmailAndPassword(users[username].email, password);
                setupUI(auth.currentUser);
            } catch (error) {
                document.getElementById('loginError').textContent = error.message;
            }
        });

        // UI Setup Based on Role
        function setupUI(user) {
            document.getElementById('loginSection').classList.add('hidden');
            
            db.collection('users').doc(user.uid).get().then(doc => {
                const userData = doc.data();
                
                if (userData.role === 'admin') {
                    document.getElementById('adminDashboard').classList.remove('hidden');
                    loadAllUsers();
                } else {
                    document.getElementById('userGreeting').textContent = userData.username;
                    document.getElementById('userDashboard').classList.remove('hidden');
                    loadUserSubmissions(user.uid);
                }
            });
        }

        // Load User-specific Data
        async function loadUserSubmissions(userId) {
            const query = db.collection('submissions')
                .where('userId', '==', userId)
                .orderBy('timestamp', 'desc');

            query.onSnapshot(snapshot => {
                const tbody = document.getElementById('userData').querySelector('tbody');
                tbody.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    tbody.innerHTML += `
                        <tr>
                            <td>${new Date(data.timestamp).toLocaleDateString()}</td>
                            <td>${data.marketName}</td>
                            <td>${data.customerName}</td>
                            <td>${data.saleAmount || 'N/A'}</td>
                        </tr>
                    `;
                });
            });
        }

        // Admin Functions
        async function loadAllUsers() {
            const usersSnapshot = await db.collection('users').get();
            const select = document.getElementById('userSelect');
            
            usersSnapshot.forEach(doc => {
                const option = document.createElement('option');
                option.value = doc.id;
                option.textContent = doc.data().username;
                select.appendChild(option);
            });
        }

        async function loadUserData(userId) {
            const userId = document.getElementById('userSelect').value;
            const query = db.collection('submissions')
                .where('userId', '==', userId)
                .orderBy('timestamp', 'desc');

            const snapshot = await query.get();
            const tbody = document.getElementById('adminData').querySelector('tbody');
            tbody.innerHTML = '';
            
            snapshot.forEach(doc => {
                const data = doc.data();
                tbody.innerHTML += `
                    <tr>
                        <td>${data.userId}</td>
                        <td>${new Date(data.timestamp).toLocaleDateString()}</td>
                        <td>${data.marketName}</td>
                        <td>${data.customerName}</td>
                        <td>${data.saleAmount || 'N/A'}</td>
                    </tr>
                `;
            });
        }

        // Logout
        function logout() {
            auth.signOut();
            window.location.reload();
        }

        // Initialize Auth Listener
        auth.onAuthStateChanged(user => {
            if (user) {
                setupUI(user);
            } else {
                document.getElementById('loginSection').classList.remove('hidden');
                document.getElementById('userDashboard').classList.add('hidden');
                document.getElementById('adminDashboard').classList.add('hidden');
            }
        });

        // Rest of your form submission code...
    </script>
</body>
</html>
