<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Activation Form</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <style>
        /* Existing styles remain the same */
        .admin-only { display: none; }
        .error-message { color: red; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="stats">
        <h2>Your Submissions</h2>
        <div id="userSubmissions"></div>
        <button onclick="logout()" style="background: #dc3545;">Logout</button>
        <a href="admin-dashboard.html" class="admin-only" id="adminLink">Admin Dashboard</a>
    </div>

    <form id="marketForm">
        <!-- Existing form fields remain the same -->
    </form>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAG2FCJ5yq-fpzkIGPJNXhUmV4C0yBCLvw",
            authDomain: "bpdb-7917b.firebaseapp.com",
            projectId: "bpdb-7917b",
            storageBucket: "bpdb-7917b.firebasestorage.app",
            messagingSenderId: "257010241868",
            appId: "1:257010241868:web:051531214d73c21558bfe9",
            measurementId: "G-TMETXCTQGL"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let currentUser = null;
        let isAdmin = false;

        // Authentication State Listener
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = "index.html";
            } else {
                currentUser = user;
                const idToken = await user.getIdTokenResult();
                isAdmin = idToken.claims.admin || false;
                
                if(isAdmin) {
                    document.getElementById('adminLink').style.display = 'inline';
                }
                
                loadUserData();
                updateStatistics();
            }
        });

        // Form Submission Handler
        document.getElementById('marketForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submissionData = {
                marketName: document.getElementById('marketName').value.trim(),
                customerName: document.getElementById('customerName').value.trim(),
                mobileNumber: document.getElementById('mobileNumber').value.trim(),
                saleMade: document.getElementById('saleMade').value,
                timestamp: new Date(),
                userId: currentUser.uid
            };

            // Validate sale amount if sale was made
            if(submissionData.saleMade === 'yes') {
                const amount = parseFloat(document.getElementById('saleAmount').value);
                if(isNaN(amount) || amount <= 0) {
                    alert('Please enter a valid sale amount');
                    return;
                }
                submissionData.saleAmount = amount;
            }

            try {
                await db.collection('submissions').add(submissionData);
                alert('Data submitted successfully!');
                
                // Reset form and update UI
                document.getElementById('marketForm').reset();
                toggleAmountField();
                updateStatistics();
                loadUserData();
            } catch (error) {
                console.error('Submission error:', error);
                alert('Error submitting data. Please try again.');
            }
        });

        // Load User Data
        async function loadUserData() {
            try {
                let query = db.collection('submissions');
                if(!isAdmin) {
                    query = query.where('userId', '==', currentUser.uid);
                }

                const snapshot = await query.get();
                const submissionsList = document.getElementById('userSubmissions');
                submissionsList.innerHTML = '<h3>Your Recent Submissions:</h3>';
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    submissionsList.innerHTML += `
                        <div class="submission-item">
                            <p>Market: ${data.marketName}</p>
                            <p>Customer: ${data.customerName}</p>
                            <p>Sale: ${data.saleMade === 'yes' ? 'à§³' + data.saleAmount : 'No sale'}</p>
                            <hr>
                        </div>
                    `;
                });
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // Update Statistics
        async function updateStatistics() {
            try {
                let query = db.collection('submissions');
                if(!isAdmin) {
                    query = query.where('userId', '==', currentUser.uid);
                }

                const snapshot = await query.get();
                let totalContacts = 0;
                let totalSalesAmount = 0;
                let salesCount = 0;

                snapshot.forEach(doc => {
                    totalContacts++;
                    const data = doc.data();
                    if(data.saleMade === 'yes' && data.saleAmount) {
                        salesCount++;
                        totalSalesAmount += parseFloat(data.saleAmount);
                    }
                });

                document.getElementById('totalContacts').textContent = totalContacts;
                document.getElementById('totalSales').textContent = totalSalesAmount.toFixed(2);
                document.getElementById('salesRatio').textContent = salesCount;
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        // Logout Function
        function logout() {
            auth.signOut();
        }

        // Toggle Amount Field Visibility
        function toggleAmountField() {
            const saleMade = document.getElementById('saleMade').value;
            const amountField = document.getElementById('amountField');
            const amountInput = document.getElementById('saleAmount');
            
            if(saleMade === 'yes') {
                amountField.style.display = 'block';
                amountInput.setAttribute('required', 'true');
            } else {
                amountField.style.display = 'none';
                amountInput.removeAttribute('required');
                amountInput.value = '';
            }
        }

        // Initial call to set correct field visibility
        toggleAmountField();
    </script>
</body>
</html>
